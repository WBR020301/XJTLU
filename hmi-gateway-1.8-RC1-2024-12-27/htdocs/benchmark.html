<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>通信调试</title>
  </head>
  <body>
    <b>通信调试</b>
    <div id="socketMsg"></div>
    <div id="timeStat"></div>
    <div id="messages"></div>
    <div id="viz" style="width:100%">
    </div>
    <script>
      function formatToThreeDigits(number) {
          return number.toString().padStart(3, '0');
      }
      let socket;
      let size = 18;
      let samples = new Array(size).fill(10);
      let index = 0;
      let minDelay = 999999;
      let maxDelay = -999999;
      let avg = 0;
      // 初始化 WebSocket 连接
      function initWebSocket() {
        try {
          socket = new WebSocket("ws://127.0.0.1:8080/ws"); // 替换为你的 WebSocket URL

          socket.onopen = function (event) {
            document.getElementById("socketMsg").innerHTML="WebSocket OPEN";
          };

          socket.onmessage = function (event) {
            const receivedTime = new Date().getTime();
            const data = event.data;
            const obj = JSON.parse(data);
            const parseTime = new Date().getTime();

            const delay =  (new Date().getTime() - obj.ts);
            samples[index] = delay;
            index++;
            index%=size;
            if(delay<50&&delay>maxDelay) maxDelay = delay;
            if(delay<minDelay) minDelay = delay;
            avg = 0;
            samples.forEach(function(number) {
                avg += number;
            });
            avg = avg / size;

            document.getElementById("timeStat").innerHTML=`Delay: ${formatToThreeDigits(delay)}, max ${formatToThreeDigits(maxDelay)}, min ${formatToThreeDigits(minDelay)}, avg ${Math.ceil(avg)}`;
            document.getElementById("messages").innerHTML=''+obj.ts;
          };

          socket.onerror = function (event) {
            window.console.log(event);
            document.getElementById("socketMsg").innerHTML="WS ERR: " + JSON.stringify(event);
          };

          socket.onclose = function (event) {
            window.console.log(event);
            document.getElementById("socketMsg").innerHTML="WS CLOSE"+JSON.stringify(event);
          };
        } catch (error) {
          window.console.log(error);
          document.getElementById("socketMsg").innerHTML="WS FAIL: " + JSON.stringify(error);
        }
      }

      // 页面加载时初始化 WebSocket
      window.onload = function () {
        setTimeout(function(){initWebSocket();}, 2000);
        setInterval(function(){
          html = '';
          let sortedArray = Array.from(samples).sort((a, b) => b - a);
          for(var i=0;i<size;i++){
            html += '<div style="color:white;background:blue;margin-top:1px;width:'+Math.max(1, sortedArray[i]*10)+'px;">'+sortedArray[i]+'</div>';
          }
          document.getElementById("viz").innerHTML=html;
        }, 1500);
      };
    </script>
  </body>
</html>
